{% extends "layout.html" %} {% block body %}
<div class="container">
    <!-- Example row of columns -->
    {% if op['status'] == 1 %}
    <br>
    <div class="row">
        <div class="col-md-6">
            <h2>Diagram Details</h2>

            <small>&nbsp;</small>
            <p>&nbsp;</p>
            <table id="diagTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Diagram</th>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Funding</th>
                        <th>System</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>Diagram</th>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Funding</th>
                        <th>System</th>
                    </tr>
                </tfoot>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="col-md-6">
            <h2>Design Synthesis</h2>
            <small>&nbsp;</small>
            <p>&nbsp;</p>
            <div id="inputmap_filter" class="inputmap"></div>
            <br>
            <div id="systemsCBCont">
                <h4>Systems</h4>
                <div id="systemsCB"></div>
                <br>
                <small id="procstatus"></small>
            </div>
            <div id ="mapControls" class="pull-right"> 
                <h4>Identify</h4>                               
                  <div class="btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-secondary active">
                      <input id="popupControl" type="checkbox" checked data-toggle="toggle"> Show Diagram Names
                    </label>
                  </div>
            </div>

        </div>
    </div>
    <br>
    <br>
    <div class="row">
        <div class="col-md-12">
            <h2>Word Cloud</h2>
            <small>A word cloud is generated by analyzing the titles of diagrams in your design.</small>
            <div id="canvas-container">
                <canvas id="cloudcanvas" class="canvas"></canvas>
            </div>
            <!-- <p><a class="btn btn-secondary" href="#" role="button">View details &raquo;</a></p> -->
        </div>
    </div>
    <br>

    <div class="row">
        <div class="col-md-12">
            <small>The chart above shows a natural language analysis of similarity of diagram titles, if two titles of a
                diagram are similar they are linked with a edge. If a chart is not loaded, please refresh after a few
                moments, the server may still be computing. </small>
        </div>
    </div>

    {% else %}
    <p>{{op['message']}} </p>
    {% endif %}
    <br>
    <br>
    <br>
    <hr>
    <footer>
        <p>&copy; 2021 Geodesignhub Design Showcase</p>
    </footer>
</div>
<!-- /container -->{% endblock %} {% block footer %} {% if op['status'] == 1 %}
<script type="text/javascript">
    var svgDrawing = SVG('drawing').size(10, 10);

    function miniMapstyleComp(feature) {
        // console.log(feature.properties)
        var curFeature = feature.geometry.type;
        if (curFeature === 'LineString') {
            // console.log(feature)
            return {
                weight: 2,
                opacity: .9,
                color: feature.properties.color,
                dashArray: '',

            };
        } else {
            // var fillColor = getColor(feature.properties.areatype);

            if (feature.properties.areatype == 'project') {
                var fillColor = feature.properties.color;
            } else { // it is policy
                var fillPattern = setSVGStyle(feature.properties.color);
                var fillColor = fillPattern;
            }

            return {
                // fillColor: feature.properties.color,
                // fillColor:'#333333',
                weight: 1,
                stroke: true,
                opacity: 0.9,
                fillColor: fillColor,
                color: feature.properties.color,
                dashArray: '',
                // opacity: 0.2,
                fillOpacity: 0.8,
            };
        }

    }

    function setSVGStyle(reqColor) {
        var pattern = svgDrawing.pattern(6, 6, function (add) {
            // add.rect(5, 5).fill(reqColor)
            add.line(0, 0, 6, 6).stroke({
                width: 1,
                color: reqColor
            })
            add.line(6, 0, 0, 6).stroke({
                width: 1,
                color: reqColor
            })
        });
        return pattern.fill();
    }

    function getColor(type) {

        return type === 'policy' ? '#707070 ' :
            type === 'project' ? '#a69695 ' :
                type === 'red2' ? '#bd0026' :
                    type === 'red' ? '#f03b20' :
                        type === 'yellow' ? '#FFFF00' :
                            type === 'green' ? '#74c476' :
                                type === 'green2' ? '#31a354' :
                                    type === 'green3' ? '#006d2c' :
                                        type === 'purple' ? '#CFACF7' :
                                            type === 'purple2' ? '#8D6CBF' :
                                                type === 'purple3' ? '#601286' :
                                                    type === 'orange' ? '#FFA927' :
                                                        type === 'orange2' ? '#F8872E' :
                                                            type === 'orange3' ? '#FC6B0A' :
                                                                type === 'constraints' ? '#343434' :
                                                                    type === 'boundaries' ? '#a6cee3' :
                                                                        type === 'boundaries2' ? '#b2df8a' :
                                                                            '#808080';
    }


    const bounds = "{{op['data']['bounds']|safe}}";
    var finaldesignJSON = {{op['data']['synthesis']|safe}};
    var diagrams = {{op['data']['diagrams']|safe}};
    var systems = {{op['data']['systems']|safe}}; //var test is now assigned to getTest which will only work on browsers  
    let synthesis_id = "{{op['data']['synthesis_id']|safe}}"; //var test is now assigned to getTest which will only work on browsers  
    const session_id = "{{op['data']['session_id']|safe}}";
    const latLngs = bounds.split(',');
    const southWest = L.latLng(latLngs[1], latLngs[0]);
    const northEast = L.latLng(latLngs[3], latLngs[2]);
    const mb = L.latLngBounds(southWest, northEast);

    var inputmap_filter = L.map('inputmap_filter', {
        minZoom: 6,
        maxZoom: 18,
        fullscreenControl: true,
    });

    var design_map_features_list = [];

    function onEachFeatureFilter(feature, layer) {

        design_map_features_list.push({
            'grid_location':feature.properties.grid_location,
            'diagram_id': feature.properties.diagramid,
            'layer': layer
        });
        if (feature.properties && feature.properties.description) {
            let popup_options = {"autoClose":false}
            layer.bindPopup('<b>'+ feature.properties.grid_location+ '</b>', popup_options);
        }
    }

    // FeatureGroup is to store editable layers
    var design_features = L.featureGroup().addTo(inputmap_filter);

    var inputbaseLayer = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://cartodb.com/attributions">CartoDB</a>',
        maxZoom: 18,
    }).addTo(inputmap_filter);
    inputmap_filter.fitBounds(mb);    
    L.geoJSON(finaldesignJSON, {
        onEachFeature: onEachFeatureFilter,
        style: miniMapstyleComp,
    }).addTo(design_features);

    function togglePopups(turnOff){
        for (let index = 0; index < design_map_features_list.length; index++) {
            const element = design_map_features_list[index];
            if(turnOff){
                element.layer.closePopup();
            }else{
                element.layer.openPopup();
            }
        }
    }

    for (var x = 0; x < systems.length; x++) {
        $('#systemsCB').append('<input class="sysCB_ind" name="sysCB" id=' + "'" + systems[x].name + "'" +
            'type="checkbox" checked /> <span class="square c-' + systems[x].color.substring(1) +
            '"></span>&nbsp;&nbsp;' + systems[x].name + '</input>&nbsp;&nbsp;');

    }

    $('#systemsCB').click(function () {
        runConstrainWorker();
    });

    function runConstrainWorker() {

        var selectedsystems = [];
        $('#systemsCB input:checked').each(function () {
            selectedsystems.push($(this).attr('id'));
        });
        $("#procstatus").show();
        table.destroy();
        $("#diagTable tbody tr").remove();
        let constraintedFeatures = {
            "type": "FeatureCollection",
            "features": []
        }
        let final_design_featlen = finaldesignJSON.features.length;

        for (var i3 = final_design_featlen - 1; i3 >= 0; i3--) {
            const curFeat = finaldesignJSON.features[i3];
            const curFeatProps = curFeat['properties'];
            const curFeatSys = curFeatProps.sysname;
            const did = curFeatProps['diagramid'];

            let srank = "";
            let system_name = "";
            let ranking = 0;
            if (selectedsystems.indexOf(curFeatSys) > -1) {
                constraintedFeatures.features.push(curFeat);

                for (let i8 = diagrams.length - 1; i8 >= 0; i8--) {
                    const cDiagram = diagrams[i8];

                    if (cDiagram.id == did) {
                        let desc = cDiagram.worlddescription;
                        let sid = cDiagram.sysid;
                        ranking = cDiagram.rank;
                        for (var j2 = systems.length - 1; j2 >= 0; j2--) {
                            var curSys = systems[j2];
                            if (curSys.id === sid) {
                                system_name = curSys.name;
                                break;
                            }
                        }
                        srank = system_name + " " + ranking + " ";

                        $('#diagTable > tbody:last-child').append('<tr><td>' + srank + '</td><td>' + did + '</td><td>' + curFeatProps['description'] + '</td><td>' + curFeatProps['fundingtype'] + '</td><td>' + curFeatProps['sysname'] + '</td></tr>');

                        break;
                    }

                }
            }
        }

        design_features.clearLayers();
        design_map_features_list = [];
        L.geoJSON(constraintedFeatures, {
            onEachFeature: onEachFeatureFilter,
            style: miniMapstyleComp,
        }).addTo(design_features);

        table = render_data_table();

        $('#diagTable tbody').on('click', 'tr', function () {
            var data = table.row(this).data();
            const diagramid = data[1];

            let dfeat_list_len = design_map_features_list.length;
            for (let index2 = 0; index2 < dfeat_list_len; index2++) {
                const cur_feat = design_map_features_list[index2];
                if (cur_feat.diagram_id == diagramid) {
                    cur_feat.layer.openPopup();
                    break;
                }
            }
        });

    }

    // load Synthesis
    // load Wordlcoud
    var wordcloud = {{ op['data']['word_frequency']| safe}};
    var systems = {{ op['data']['systems']| safe}};

    WordCloud(document.getElementById('cloudcanvas'), {
        'list': wordcloud,
        'color': '#7b8a8a'
    });

    for (var i2 = finaldesignJSON.features.length - 1; i2 >= 0; i2--) {
        const curFeat = finaldesignJSON.features[i2];
        const curFeatProps = curFeat['properties'];
        const did = curFeatProps['diagramid'];
        var srank = "";
        for (var i1 = diagrams.length - 1; i1 >= 0; i1--) {
            var cDiagram = diagrams[i1];
            if (cDiagram.id == did) {
                desc = cDiagram.worlddescription;
                var sid = cDiagram.sysid;
                var tranking = cDiagram.rank;
                for (var j1 = systems.length - 1; j1 >= 0; j1--) {
                    var curSys = systems[j1];
                    if (curSys.id === sid) {
                        sysname = curSys.name;
                        break;
                    }
                }
                srank = sysname + " " + tranking + " ";
                break;
            }
        }

        $('#diagTable > tbody:last-child').append('<tr><td>' + srank + '</td><td>' + did + '</td><td>' + curFeatProps['description'] + '</td><td>' + curFeatProps['fundingtype'] + '</td><td>' + curFeatProps['sysname'] + '</td></tr>');

    }

    function render_data_table() {

        var table = $('#diagTable').DataTable({
            "rowGroup": {
                dataSrc: 'group'
            },
            "columnDefs": [{
                "width": "10%",
                "visible": false,
                "targets": [1, 3],

            }],
            "order": [
                [3, 'asc']
            ],
            "bInfo": false,
            "searching": false,
            "pageLength": 10,
            "drawCallback": function (settings) {
                var api = this.api();
                var rows = api.rows({
                    page: 'current'
                }).nodes();
                var last = null;

                api.column(4, {
                    page: 'current'
                }).data().each(function (group, i) {
                    if (last !== group) {
                        $(rows).eq(i).before(
                            '<tr class="group"><td colspan="5">' + group + '</td></tr>'
                        );

                        last = group;
                    }
                });
            }
        });


        return table;
    }

    let table = render_data_table();
    $('#diagTable tbody').on('click', 'tr', function () {
        var data = table.row(this).data();
        const diagramid = data[1];

        let dfeat_list_len = design_map_features_list.length;
        for (let index2 = 0; index2 < dfeat_list_len; index2++) {
            const cur_feat = design_map_features_list[index2];
            if (cur_feat.diagram_id == diagramid) {
                cur_feat.layer.openPopup();
                break;
            }
        }
    });






</script>
{% endif %} {% endblock %}