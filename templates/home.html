{% extends "layout.html" %} {% block body %}
<div class="container">
    <!-- Example row of columns -->
    {% if op['status'] == 1 %}
    <div class="row">
        <div class="col-md-6">
            <h2>Design Synthesis</h2>
            <small>&nbsp;</small>
            <div id="inputmap"></div>
            <!-- <p><a class="btn btn-secondary" href="#" role="button">View details &raquo;</a></p> -->
        </div>
        <div class="col-md-6">
            <h2>Word Cloud</h2>
            <small>A word cloud is generated by analyzing the title of diagrams in your design synthesis.</small>
            <div id="canvas-container">
                <canvas id="cloudcanvas" class="canvas"></canvas>
            </div>
            <!-- <p><a class="btn btn-secondary" href="#" role="button">View details &raquo;</a></p> -->
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-12">
            <h2>Diagram Details</h2>
            <small>All the diagrams selected in this design grouped by the system.</small>
            <p>&nbsp;</p>
            <table id="diagTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Diagram</th>
                        <th>Title</th>
                        <th>System</th>
                        <th>Start date</th>
                        <th>End Date</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>Diagram</th>
                        <th>Title</th>
                        <th>System</th>
                        <th>Start date</th>
                        <th>End Date</th>
                    </tr>
                </tfoot>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <br>
    <br>
    <div class="row">
        <div class="col-md-12">
            <h2>Diagram Connections</h2>
            <small>All the diagrams are linked when are communicating teh asme idea.</small>
            <p>&nbsp;</p>
            <div id="graphcontainer"></div>
        </div>
    </div>
    {% else %}
    <p>{{op['message']}} </p>
    {% endif %}
    <br>
    <br>
    <br>
    <hr>
    <footer>
        <p>&copy; Geodesignhub 2018</p>
    </footer>
</div>
<!-- /container -->{% endblock %} {% block footer %} {% if op['status'] == 1 %}
<script type="text/javascript">
var svgDrawing = SVG('drawing').size(10, 10);

function miniMapstyleComp(feature) {
    // console.log(feature.properties)
    var curFeature = feature.geometry.type;
    if (curFeature === 'LineString') {
        // console.log(feature)
        return {
            weight: 2,
            opacity: .9,
            color: feature.properties.color,
            dashArray: '',

        };
    } else {
        // var fillColor = getColor(feature.properties.areatype);

        if (feature.properties.areatype == 'project') {
            var fillColor = feature.properties.color;
        } else { // it is policy
            var fillPattern = setSVGStyle(feature.properties.color);
            var fillColor = fillPattern;
        }

        return {
            // fillColor: feature.properties.color,
            // fillColor:'#333333',
            weight: 1,
            stroke: true,
            opacity: 0.9,
            fillColor: fillColor,
            color: feature.properties.color,
            dashArray: '',
            // opacity: 0.2,
            fillOpacity: 0.8,
        };
    }

}

function setSVGStyle(reqColor) {
    var pattern = svgDrawing.pattern(6, 6, function(add) {
        // add.rect(5, 5).fill(reqColor)
        add.line(0, 0, 6, 6).stroke({
            width: 1,
            color: reqColor
        })
        add.line(6, 0, 0, 6).stroke({
            width: 1,
            color: reqColor
        })
    });
    return pattern.fill();
}

function getColor(type) {

    return type === 'policy' ? '#707070 ' :
        type === 'project' ? '#a69695 ' :
        type === 'red2' ? '#bd0026' :
        type === 'red' ? '#f03b20' :
        type === 'yellow' ? '#FFFF00' :
        type === 'green' ? '#74c476' :
        type === 'green2' ? '#31a354' :
        type === 'green3' ? '#006d2c' :
        type === 'purple' ? '#CFACF7' :
        type === 'purple2' ? '#8D6CBF' :
        type === 'purple3' ? '#601286' :
        type === 'orange' ? '#FFA927' :
        type === 'orange2' ? '#F8872E' :
        type === 'orange3' ? '#FC6B0A' :
        type === 'constraints' ? '#343434' :
        type === 'boundaries' ? '#a6cee3' :
        type === 'boundaries2' ? '#b2df8a' :
        '#808080';
}


var bounds = "{{op['data']['bounds']|safe}}";
var finaldesignJSON = {{op['data']['synthesis']|safe}};
var diagrams = {{op['data']['diagrams']|safe}};
var latLngs = bounds.split(',');
var southWest = L.latLng(latLngs[1], latLngs[0]);
var northEast = L.latLng(latLngs[3], latLngs[2]);
var mb = L.latLngBounds(southWest, northEast);
var inputmap = L.map('inputmap', {
    zoomControl: true,
    minZoom: 6,
    maxZoom: 18,
});

function onEachFeature(feature, layer) {
    // does this feature have a property named popupContent?
    if (feature.properties && feature.properties.description) {
        layer.bindPopup(feature.properties.description);
    }
}

// FeatureGroup is to store editable layers
var designLayer = new L.FeatureGroup();

var inputbaseLayer = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://cartodb.com/attributions">CartoDB</a>',
    maxZoom: 18,
}).addTo(inputmap);
inputmap.fitBounds(mb);

// L.geoJSON(finaldesignJSON, {
//     onEachFeature: onEachFeature,
//     style: miniMapstyleComp,
// }).addTo(inputmap);

var timelineControl = L.timelineSliderControl({
    formatOutput: function(date) {
        return moment(date).format("YYYY-MM-DD");
    }
});
var timeline = L.timeline(finaldesignJSON, {

    onEachFeature: onEachFeature,
    style: miniMapstyleComp,
});
timelineControl.addTo(inputmap);
timelineControl.addTimelines(timeline);
timeline.addTo(inputmap);


// load Synthesis
// load Wordlcoud
var wordcloud = {{op['data']['wordfreq']|safe}};
var fuzzyMatches = {{op['data']['fuzzymatches']|safe}};
var systems = {{op['data']['systems']|safe}};

WordCloud(document.getElementById('cloudcanvas'), { 'list': wordcloud, 'color': '#7b8a8a' });

for (var i = finaldesignJSON.features.length - 1; i >= 0; i--) {
    const curFeat = finaldesignJSON.features[i];
    const curFeatProps = curFeat['properties'];
    $('#diagTable > tbody:last-child').append('<tr><td>' + curFeatProps['diagramid'] + '</td><td>' + curFeatProps['description'] + '</td><td>' + curFeatProps['sysname'] + '</td><td>' + curFeatProps['start'] + '</td><td>' + curFeatProps['end'] + '</td></tr>');


}
var table = $('#diagTable').DataTable({
    "rowGroup": {
        dataSrc: 'group'
    },
    "columnDefs": [
        { "visible": false, "targets": 2 }
    ],
    "order": [
        [2, 'asc']
    ],
    "displayLength": 25,
    "drawCallback": function(settings) {
        var api = this.api();
        var rows = api.rows({ page: 'current' }).nodes();
        var last = null;

        api.column(2, { page: 'current' }).data().each(function(group, i) {
            if (last !== group) {
                $(rows).eq(i).before(
                    '<tr class="group"><td colspan="5">' + group + '</td></tr>'
                );

                last = group;
            }
        });
    }
});

// Order by the grouping
$('#diagTable tbody').on('click', 'tr.group', function() {
    var currentOrder = table.order()[0];
    if (currentOrder[0] === 2 && currentOrder[1] === 'asc') {
        table.order([2, 'desc']).draw();
    } else {
        table.order([2, 'asc']).draw();
    }
});
$('#diagTable tbody').on('click', 'tr', function() {
    var data = table.row(this).data();
    const diagramid = data[0];
    if (diagramid in fuzzyMatches) {
        const related = fuzzyMatches[diagramid];
        console.log(related)
    }

});
var graphData = { "nodes": [], "edges": [] };
for (var diagramid in fuzzyMatches) {
    var links = fuzzyMatches[diagramid];
    var desc = "";
    var sysid = "";
    var sysname = "";
    var sysrank = "";
    for (var i = diagrams.length - 1; i >= 0; i--) {
        var curDiagram = diagrams[i];
        if (curDiagram.id == diagramid) {
            desc = curDiagram.worlddescription;
            var sysid = curDiagram.sysid;
            var ranking = curDiagram.rank;
            for (var j = systems.length - 1; j >= 0; j--) {
                var curSys = systems[j];
                if (curSys.id === sysid) {
                    sysname = curSys.sysname;
                    syscolor = curSys.syscolor;
                    break;
                }
            }
            sysrank = sysname + " " + ranking +" ";
            break;
        }
    }
    graphData.nodes.push({ "size":0.001, "id": diagramid,"color":syscolor, "label": sysrank  , "x":Math.random(), "y":Math.random()});
    for (var k = links.length - 1; k >= 0; k--) {
        var curLink = links[k];
        if (curLink !== 0){

            graphData.edges.push({ "id": diagramid +"-" +curLink,"source":diagramid, "target":curLink,'color': '#ccc'});
        }
    }
}

s = new sigma({
  graph: graphData,
  container: 'graphcontainer',
  labelSize: 'proportional'
});
</script>
{% endif %} {% endblock %}